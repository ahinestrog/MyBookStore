<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventario - MyBookStore</title>
  <link rel="stylesheet" href="/inventory/static/style.css?v=3">
</head>
<body>
  <header class="navbar">
    <a class="brand" href="/catalog/">� MyBookStore</a>
    <form class="search" action="/catalog/" method="get">
      <input type="text" name="q" placeholder="Buscar libro..." value="">
      <button type="submit">🔍</button>
    </form>
    <nav class="navlinks">
      <a href="/catalog/">📖 Catálogo</a>
      <a href="/cart/">🛒 Carrito</a>
      <a href="/order/">📦 Órdenes</a>
      {{if .LoggedIn}}
      <span>👋 {{.UserName}}</span>
      <a href="/user/logout">Cerrar sesión</a>
      {{else}}
      <a href="/user/">👤 Usuario</a>
      {{end}}
      <a href="/inventory/" class="active">📊 Inventario</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2>📊 Panel de Inventario</h2>
      <p>Consulta la disponibilidad de libros en el sistema</p>
    </section>

    <section class="card">
      <h3>Consultar Disponibilidad</h3>
      <p style="color: var(--muted); margin-bottom: 1rem;">Ingresa los IDs de libros separados por coma (ej: <code>1,2,3</code>)</p>
      <form id="inventoryForm" style="display: flex; gap: 0.5rem;">
        <input type="text" id="bookIds" placeholder="IDs de libros..." value="{{.Prefill}}" required style="flex: 1;">
        <button type="submit" class="btn primary">Consultar</button>
      </form>
    </section>

    <section class="card">
      <h3>Resultados</h3>
      <table id="results" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 1px solid var(--line);">
            <th style="padding: 0.8rem; text-align: left;">ID Libro</th>
            <th style="padding: 0.8rem; text-align: left;">Cantidad Disponible</th>
            <th style="padding: 0.8rem; text-align: left;">Estado</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </section>
  </main>

  <footer class="footer">
    <small>© 2025 MyBookStore · Sistema de Gestión de Librerías</small>
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("inventoryForm");
      const tbody = document.querySelector("#results tbody");
      const idsInput = document.getElementById("bookIds");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const ids = idsInput.value.trim();
        if (!ids) return alert("Por favor ingresa IDs.");

        try {
          const resp = await fetch("/inventory/api/inventory?ids=" + encodeURIComponent(ids));
          if (!resp.ok) throw new Error("Error en servidor");
          const data = await resp.json();
          render(data.items || []);
        } catch (err) {
          console.error(err);
          alert("Error al consultar inventario.");
        }
      });

      function render(items) {
        tbody.innerHTML = "";
        if (items.length === 0) {
          tbody.innerHTML = "<tr><td colspan='3'>Sin resultados</td></tr>";
          return;
        }

        for (const it of items) {
          const st = it.available_qty > 5 ? "ok" : it.available_qty > 0 ? "low" : "out";
          const row = `
            <tr>
              <td>${it.book_id}</td>
              <td>${it.available_qty}</td>
              <td class="status-${st}">${statusText(st)}</td>
            </tr>
          `;
          tbody.innerHTML += row;
        }
      }

      function statusText(s) {
        return s === "ok" ? "En stock" : s === "low" ? "Pocas unidades" : "Agotado";
      }

      // Auto-disparar consulta si viene con ?ids= en la URL
      const url = new URL(window.location.href);
      const pre = url.searchParams.get("ids");
      if (pre && pre.trim() !== "") {
        idsInput.value = pre;
        form.requestSubmit();
      }
    });
  </script>
</body>
</html>
